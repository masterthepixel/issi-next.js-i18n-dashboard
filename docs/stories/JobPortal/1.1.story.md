h Story: 1.1 - Implement User Authentication & Role Management

**Status:** Draft
**Epic:** 1 - User Management & Authentication
**Story Points:** 8
**Priority:** High
**Assigned To:** [Unassigned]

## Story Statement

As a system administrator, I want to implement a secure user authentication system with role-based access control so that Job Seekers and Companies can access appropriate features while maintaining data security and compliance.

## Acceptance Criteria

- [ ] Users can authenticate via email/password or SSO
- [ ] System supports 2 distinct user roles: Job Seeker and Company (aligned with reference implementation)
- [ ] Role-based access control is enforced for all system features
- [ ] Authentication is secure with proper password hashing
- [ ] Users can only access features appropriate to their role
- [ ] Company users can manage their job listings and company profiles
- [ ] Session management is implemented with proper timeouts
- [ ] Password reset functionality is available

## Technical Requirements

### Reference Implementation Adaptation

**üìÅ Reference Repository:** `docs/reference-repos/job-marshal-finale-locale-main`

**üîß Implementation Strategy:** Copy and adapt 85%+ of the reference authentication system for PayloadCMS integration.

### Key Reference Components to Adapt

#### 1. Authentication Pages

**Reference:** `app/login/`, `app/onboarding/`
**Target:** `src/app/[locale]/auth/`

```typescript
// Adapt existing login and onboarding flows
// Replace NextAuth.js with PayloadCMS authentication
// Add internationalization support
```

#### 2. User Type Selection

**Reference:** `components/forms/onboarding/UserTypeSelection.tsx`
**Target:** `src/components/auth/UserTypeSelection.tsx`

```typescript
// Copy existing user type selection component
// Adapt for PayloadCMS role system
// Add i18n support
```

#### 3. Onboarding Forms

**Reference:** `components/forms/onboarding/JobSeekerForm.tsx`, `CompanyForm.tsx`
**Target:** `src/components/auth/JobSeekerForm.tsx`, `CompanyForm.tsx`

```typescript
// Copy existing forms with React Hook Form + Zod validation
// Replace Prisma mutations with PayloadCMS API calls
// Maintain existing validation and error handling
```

#### 4. Authentication Utilities

**Reference:** `app/utils/auth.ts`
**Target:** `src/lib/auth/auth.ts`

```typescript
// Adapt NextAuth.js configuration for PayloadCMS
// Update session handling and token management
// Maintain existing auth utilities
```

### API Integration

**Replace NextAuth.js with PayloadCMS:**

```typescript
// BEFORE (NextAuth.js)
const { data: session } = useSession();

// AFTER (PayloadCMS)
const { data: user } = usePayloadCMSUser();
```

**Authentication Flow:**

```typescript
// BEFORE (NextAuth.js)
await signIn("credentials", { email, password });

// AFTER (PayloadCMS)
const response = await fetch("/api/auth/login", {
  method: "POST",
  body: JSON.stringify({ email, password }),
});
```

### Data Structure Mapping

### External API Data Consumption Requirements

**Authentication API Endpoints:**

- `POST /api/auth/register` - User registration
- `POST /api/users/login` - User login
- `GET /api/auth/me` - Get current user profile (assumed)
- `POST /api/auth/logout` - User logout (assumed)

**Expected API Response Fields (Confirmed from API Test):**

**User Profile Response:**

```typescript
interface User {
  id: string;
  name: string;
  email: string;
  userType: "COMPANY" | "JOB_SEEKER"; // Confirmed: Pull this field for role-based UI
  onboardingCompleted: boolean; // Confirmed: Pull this field for flow routing
  stripeCustomerId: string | null; // Confirmed: Pull this field for payments
  sessions: any[]; // Confirmed: For auth sessions
  updatedAt: string;
  createdAt: string;
}
```

**Fields to Pull from External API:**

- `id` (user ID)
- `name` (display name)
- `email` (user email)
- `userType` (for role-based UI/permissions)
- `onboardingCompleted` (for user flow routing)
- `stripeCustomerId` (for payment features)
- `sessions` (for session management)
- `updatedAt`, `createdAt` (timestamps)

**API Request/Response Patterns:**

```typescript
// Login request
const response = await fetch("https://issi-dashboard-payloadcms.vercel.app/api/users/login", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ email, password }),
});
const { user, token } = await response.json();

// Get user profile (assumed endpoint)
const response = await fetch("https://issi-dashboard-payloadcms.vercel.app/api/auth/me", {
  headers: { Authorization: `Bearer ${token}` },
});
const user = await response.json();
```

**Adapt from Reference:**

- Copy authentication flow from `UserTypeSelection.tsx`
- Adapt login form from `LoginForm.tsx`
- Use external API endpoints for authentication
- Map API response fields to component state

### Internationalization

**URL Structure:**

- English: `/auth/login`, `/auth/onboarding`
- Spanish: `/auth/iniciar-sesion`, `/auth/incorporacion`
- French: `/auth/connexion`, `/auth/integration`

### File Structure (Adapted from Reference)

```
src/
‚îú‚îÄ‚îÄ app/[locale]/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                 # Adapted from reference login page
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ onboarding/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                 # Adapted from reference onboarding page
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx                       # Locale-aware layout
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ auth/
‚îÇ       ‚îú‚îÄ‚îÄ UserTypeSelection.tsx        # Adapted from reference UserTypeSelection.tsx
‚îÇ       ‚îú‚îÄ‚îÄ JobSeekerForm.tsx            # Adapted from reference JobSeekerForm.tsx
‚îÇ       ‚îú‚îÄ‚îÄ CompanyForm.tsx              # Adapted from reference CompanyForm.tsx
‚îÇ       ‚îî‚îÄ‚îÄ OnboardingForm.tsx           # Adapted from reference OnboardingForm.tsx
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ auth/
        ‚îú‚îÄ‚îÄ auth.ts                      # Adapted from reference auth.ts
        ‚îî‚îÄ‚îÄ session.ts                   # New: PayloadCMS session management
```

## Implementation Tasks

### Phase 1: Authentication Setup

1. **Adapt Reference Auth System**

   - Copy login and onboarding pages from reference
   - Update routing for internationalization
   - Replace NextAuth.js with PayloadCMS authentication

2. **Update User Type Selection**

   - Copy UserTypeSelection component
   - Adapt for PayloadCMS role system
   - Add i18n support for role labels

3. **Adapt Onboarding Forms**
   - Copy JobSeekerForm and CompanyForm
   - Replace Prisma mutations with PayloadCMS API
   - Maintain React Hook Form + Zod validation

### Phase 2: API Integration

4. **Implement PayloadCMS Auth API**

   - Create `/api/auth/login` endpoint
   - Create `/api/auth/register` endpoint
   - Create `/api/auth/logout` endpoint
   - Add session management utilities

5. **Update Authentication Flow**
   - Replace NextAuth.js hooks with PayloadCMS equivalents
   - Update session handling and token management
   - Maintain existing auth state management

### Phase 3: Role-Based Access Control

6. **Implement Role Guards**

   - Create role-based route protection for Job Seeker vs Company features
   - Add permission checking utilities
   - Update navigation based on user roles

7. **Company User Management**
   - Allow companies to manage their job listings
   - Enable company profile management
   - Implement company-specific CRUD operations

## Dependencies

- Reference Repository: `docs/reference-repos/job-marshal-finale-locale-main`
- PayloadCMS authentication system
- React Hook Form + Zod validation (from reference)
- Internationalization setup

### Upcoming Stories (Anticipated Based on Patterns)

- **Job Detail Pages**: Consume `GET /api/jobposts/{id}`; pull detailed job fields (same as 2.1/3.1).
- **Application Management**: Consume `POST /api/savedjobposts`, `GET /api/savedjobposts`; pull application status, saved jobs.
- **Company Profiles**: Consume `GET /api/companies/{id}`; pull detailed company fields (same as 2.1).
- **Admin Dashboard**: Consume admin-specific endpoints; pull user/job management fields.
